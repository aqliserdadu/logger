#!/bin/bash
# ============================================
#  logger (Smart Portable Analyzer System) - Control Script
# ============================================
# Nama Aplikasi : Smart Portable Analyzer System (logger)
# Deskripsi     : Kontrol script untuk sistem pemantauan cuaca dan kualitas udara
# Dibuat oleh   : Abu Bakar <abubakar.it.dev@gmail.com>
# Versi         : 1.0
# Lisensi       : Private/Internal Project
# ============================================

# Strict mode untuk penanganan error yang lebih baik
set -euo pipefail
trap 'echo "âŒ Error pada baris $LINENO. Perintah gagal: $BASH_COMMAND"' ERR

# Konfigurasi
readonly SERVICES=("logger-sensor.service" "logger-web.service" "logger-web-log.service" "logger-backup.service" "logger-gpio.service" "logger-klhk-send.service" "logger-klhk-retry.service" "logger-has-send.service")
readonly LOG_DIR="/opt/logger/logs"
readonly APP_BASE="/opt/logger"
readonly BIN_PATH="/usr/bin/logger"
readonly DB_DIR="$APP_BASE/database"

# Fungsi untuk menampilkan pesan error dan keluar
error_exit() {
    echo "âŒ $1" >&2
    exit 1
}

# Fungsi untuk memeriksa privilege
check_privileges() {
    if [[ $EUID -ne 0 ]]; then
        echo "âš ï¸  Perintah ini membutuhkan privilege root. Silakan gunakan sudo." >&2
        exit 1
    fi
}

# Fungsi untuk memeriksa apakah service ada
check_exists() {
    echo "ğŸ” Memeriksa keberadaan service..."
    local found=false
    for service in "${SERVICES[@]}"; do
        if [ -f "/etc/systemd/system/$service" ]; then
            echo "âœ” $service ditemukan"
            found=true
        else
            echo "âœ– $service TIDAK ditemukan"
        fi
    done
    
    if [ "$found" = false ]; then
        error_exit "Tidak ada service yang ditemukan. Silakan jalankan installer terlebih dahulu."
    fi
}

# Fungsi untuk memulai semua service
start_services() {
    check_privileges
    echo "ğŸš€ Memulai semua service..."
    for service in "${SERVICES[@]}"; do
        if systemctl is-active --quiet "$service"; then
            echo "â„¹ï¸  $service sudah berjalan"
        else
            systemctl start "$service" && echo "â–¶ï¸ $service dijalankan" || echo "âŒ Gagal menjalankan $service"
        fi
    done
    echo "âœ… Semua service telah diproses."
}

# Fungsi untuk menghentikan semua service
stop_services() {
    check_privileges
    echo "ğŸ›‘ Menghentikan semua service..."
    for service in "${SERVICES[@]}"; do
        if systemctl is-active --quiet "$service"; then
            systemctl stop "$service" && echo "â¹ï¸ $service dihentikan" || echo "âŒ Gagal menghentikan $service"
        else
            echo "â„¹ï¸  $service sudah tidak berjalan"
        fi
    done
    echo "âœ… Semua service telah diproses."
}

# Fungsi untuk memulai service spesifik
start_service_by_name() {
    check_privileges
    local name="$1"
    local service_name="logger-${name}.service"
    
    if [[ ! " ${SERVICES[*]} " == *"$service_name"* ]]; then
        error_exit "Service '$name' tidak dikenal. Gunakan 'logger help' untuk melihat service yang tersedia."
    fi
    
    if systemctl is-active --quiet "$service_name"; then
        echo "â„¹ï¸  $service_name sudah berjalan"
    else
        systemctl start "$service_name" && echo "â–¶ï¸ $service_name dijalankan" || error_exit "Gagal menjalankan $service_name"
    fi
}

# Fungsi untuk menghentikan service spesifik
stop_service_by_name() {
    check_privileges
    local name="$1"
    local service_name="logger-${name}.service"
    
    if [[ ! " ${SERVICES[*]} " == *"$service_name"* ]]; then
        error_exit "Service '$name' tidak dikenal. Gunakan 'logger help' untuk melihat service yang tersedia."
    fi
    
    if systemctl is-active --quiet "$service_name"; then
        systemctl stop "$service_name" && echo "â¹ï¸ $service_name dihentikan" || error_exit "Gagal menghentikan $service_name"
    else
        echo "â„¹ï¸  $service_name sudah tidak berjalan"
    fi
}

# Fungsi untuk mereset semua service
reset_services() {
    echo "ğŸ”„ Mereset semua service..."
    stop_services
    sleep 2
    start_services
}

# Fungsi untuk menampilkan status semua service
status_services() {
    echo "ğŸ“Š Status semua service:"
    echo "========================================"
    
    for service in "${SERVICES[@]}"; do
        echo -n "ğŸ“‹ Status $service: "
        if systemctl is-active --quiet "$service"; then
            echo -e "\033[32mAKTIF\033[0m"
        else
            echo -e "\033[31mTIDAK AKTIF\033[0m"
        fi
        
        if systemctl is-enabled --quiet "$service"; then
            echo "   Status: Enabled"
        else
            echo "   Status: Disabled"
        fi
        
        echo "----------------------------------------"
    done
    
    echo "ğŸ’¡ Untuk detail lebih lanjut, jalankan: systemctl status <service>"
}

# Fungsi untuk uninstall
uninstall_services() {
    check_privileges
    echo "ğŸš¨ Memulai proses uninstall logger (Smart Portable Analyzer System)..."
    echo "âš ï¸  Operasi ini akan menghapus semua service dan file aplikasi!"
    
    # Konfirmasi sebelum uninstall
    read -p "â“ Apakah Anda yakin ingin melanjutkan uninstall? [y/N]: " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "âŒ Uninstall dibatalkan."
        exit 1
    fi
    
    # Tanya tentang database
    read -p "â“ Apakah Anda ingin menghapus database? [y/N]: " -n 1 -r
    echo
    DELETE_DB=$REPLY
    
    echo "ğŸ›‘ Menghentikan dan menonaktifkan service..."
    for service in "${SERVICES[@]}"; do
        if systemctl is-active --quiet "$service"; then
            systemctl stop "$service" && echo "âœ… $service dihentikan" || echo "âŒ Gagal menghentikan $service"
        fi
        
        if systemctl is-enabled --quiet "$service"; then
            systemctl disable "$service" && echo "âœ… $service dinonaktifkan" || echo "âŒ Gagal menonaktifkan $service"
        fi
        
        if [ -f "/etc/systemd/system/$service" ]; then
            rm -f "/etc/systemd/system/$service" && echo "ğŸ—‘ï¸ $service dihapus" || echo "âŒ Gagal menghapus $service"
        fi
    done
    
    echo "ğŸ”„ Reload systemd daemon..."
    systemctl daemon-reload
    systemctl reset-failed
    
    if [[ $DELETE_DB =~ ^[Yy]$ ]]; then
        echo "ğŸ—‘ï¸ Menghapus seluruh direktori $APP_BASE termasuk database..."
        rm -rf "$APP_BASE" && echo "âœ… Direktori aplikasi dihapus" || echo "âŒ Gagal menghapus direktori aplikasi"
    else
        echo "âš ï¸ Menyisakan database. Menghapus semua kecuali folder $DB_DIR..."
        if [ -d "$APP_BASE" ]; then
            find "$APP_BASE" -mindepth 1 -not -path "$DB_DIR" -not -path "$DB_DIR/*" -exec rm -rf {} + && echo "âœ… Aplikasi dihapus (database disimpan)" || echo "âŒ Gagal menghapus aplikasi"
        fi
        echo "âœ… Folder database tetap disimpan di $DB_DIR"
    fi
    
    if [ -f "$BIN_PATH" ]; then
        rm -f "$BIN_PATH" && echo "ğŸ—‘ï¸ CLI logger dihapus dari $BIN_PATH" || echo "âŒ Gagal menghapus CLI logger"
    else
        echo "â„¹ï¸  CLI logger tidak ditemukan di $BIN_PATH, dilewati."
    fi
    
    echo "âœ… Uninstall selesai. Sistem telah dibersihkan."
}

# Fungsi untuk menampilkan menu bantuan
help_menu() {
    echo "========================================================================================================"
    echo " Smart Portable Analyzer System (logger) - Control Script"
    echo "========================================================================================================"
    echo "ğŸ“Œ Dibuat oleh        : Abu Bakar <abubakar.it.dev@gmail.com>"
    echo "ğŸ“Œ Deskripsi          : Sistem pemantauan cuaca dan kualitas udara otomatis berbasis Python & API"
    echo "ğŸ“Œ Lokasi Instalasi   : /opt/logger"
    echo "ğŸ“Œ Service            : logger-sensor, logger-web, logger-web-log, logger-backup, logger-klhk-send, logger-klhk-retry"
    echo "ğŸ“Œ Web Port           : 0.0.0.0:5010"
    echo "ğŸ“Œ Web Log Port       : 0.0.0.0:3000"
    echo "ğŸ“Œ PhpMyAdmin         : 0.0.0.0:8080"
    echo "========================================================================================================="
    echo ""
    echo "Penggunaan: logger [perintah] [opsi]"
    echo ""
    echo "Service yang tersedia:"
    echo "  sensor              â†’ Pembaca sensor"
    echo "  web                 â†’ Web Dashboard"
    echo "  web-log             â†’ Web Dashboard Log"
    echo "  backup              â†’ Backup Data"
    echo "  klhk-send           â†’ API kirim data KLHK"
    echo "  klhk-retry          â†’ Retry API kirim data KLHK"
    echo ""
    echo "Perintah yang tersedia:"
    echo "  uninstall           â†’ Hapus logger (membutuhkan konfirmasi)"
    echo "  start               â†’ Menjalankan semua service"
    echo "  stop                â†’ Menghentikan semua service"
    echo "  start [nama]        â†’ Jalankan service spesifik (contoh: logger start backup)"
    echo "  stop [nama]         â†’ Hentikan service spesifik (contoh: logger stop backup)"
    echo "  reset               â†’ Reset semua service (stop lalu start)"
    echo "  status              â†’ Tampilkan status semua service"
    echo "  check               â†’ Cek apakah file service sudah ada"
    echo "  help                â†’ Tampilkan menu bantuan"
    echo ""
    echo "=========================================================================================================="
}

# === Entry Point ===
case "${1:-}" in
    uninstall)
        uninstall_services
        ;;
    start)
        if [ -n "${2:-}" ]; then
            start_service_by_name "$2"
        else
            start_services
        fi
        ;;
    stop)
        if [ -n "${2:-}" ]; then
            stop_service_by_name "$2"
        else
            stop_services
        fi
        ;;
    reset)
        reset_services
        ;;
    status)
        status_services
        ;;
    check)
        check_exists
        ;;
    help|"")
        help_menu
        ;;
    *)
        echo "âŒ Perintah tidak dikenal: $1"
        echo "ğŸ’¡ Gunakan 'logger help' untuk melihat perintah yang tersedia."
        exit 1
        ;;
esac